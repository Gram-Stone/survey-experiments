# Render Deployment Guide

## Pre-Deployment Checklist

- [x] Package.json configured with `start` script
- [x] Server.js uses `process.env.PORT`
- [x] MongoDB URI ready for environment variables
- [x] Session secret will be generated by Render
- [x] AMT integration endpoints configured

## Deployment Steps

### 1. Push to GitHub/GitLab
```bash
git add .
git commit -m "Add AMT integration and experiment control system"
git push origin main
```

### 2. Create New Service on Render

1. Go to [dashboard.render.com](https://dashboard.render.com)
2. Click "New +" â†’ "Web Service"
3. Connect your GitHub/GitLab repository
4. Choose this repository

### 3. Configure Service Settings

**Basic Info:**
- **Name**: `survey-experiments` (or your preferred name)
- **Environment**: `Node`
- **Region**: `Oregon (US West)` (recommended)
- **Branch**: `main`

**Build & Deploy:**
- **Build Command**: `npm install`
- **Start Command**: `npm start`

### 4. Set Environment Variables

Add these in the Environment section:

**Required:**
```
NODE_ENV=production
MONGODB_URI=[your-complete-mongodb-atlas-connection-string]
SESSION_SECRET=[Generate random 32+ character string]
```

**AMT Configuration:**
```
BASE_URL=https://your-app-name.onrender.com
AMT_ENDPOINT=https://mturk-requester-sandbox.us-east-1.amazonaws.com
AMT_REGION=us-east-1
AMT_REWARD=1.00
```

**Optional (add when you have AWS credentials):**
```
AMT_ACCESS_KEY_ID=your_access_key
AMT_SECRET_ACCESS_KEY=your_secret_key
```

### 5. Deploy

1. Click "Create Web Service"
2. Wait for deployment (usually 2-3 minutes)
3. Your app will be available at `https://your-app-name.onrender.com`

## Post-Deployment Steps

### 1. Update BASE_URL
After deployment, update the `BASE_URL` environment variable in Render dashboard to match your actual URL.

### 2. Test Your Deployment

Visit these URLs to verify everything works:

- **Dashboard**: `https://your-app-name.onrender.com/dashboard`
- **AMT Parameters**: `https://your-app-name.onrender.com/amt-parameters/novemsky2007`
- **Test Experiment**: `https://your-app-name.onrender.com/?experiment=novemsky2007&workerId=TEST&assignmentId=TEST&hitId=TEST`

### 3. Verify Database Connection

Check the Render logs to ensure MongoDB connection is successful:
```
Connected to MongoDB
Server running on port 10000
```

### 4. Test AMT Integration

1. Get HIT parameters: `https://your-app-name.onrender.com/amt-parameters/novemsky2007`
2. Copy the JSON response
3. Use these parameters to create a test HIT in MTurk Sandbox

## Troubleshooting

### Common Issues:

**Build Fails:**
- Check Node.js version in package.json engines
- Verify all dependencies are in package.json
- Check for syntax errors in JavaScript files

**Environment Variable Issues:**
- Ensure MONGODB_URI is exactly copied (no extra spaces)
- Verify BASE_URL matches your actual Render URL
- Check that SESSION_SECRET is at least 32 characters

**Database Connection Fails:**
- Verify MongoDB Atlas allows connections from all IPs (0.0.0.0/0)
- Check MongoDB URI format and credentials
- Ensure database user has read/write permissions

**AMT Integration Issues:**
- Verify BASE_URL is set to your actual Render domain
- Check that experiment configurations are properly loaded
- Test AMT parameters endpoint returns valid JSON

### Performance Notes:

**Free Tier Limitations:**
- Service sleeps after 15 minutes of inactivity
- First request after sleep may take 30+ seconds
- 750 hours/month limit (sufficient for research)

**For Production Studies:**
- Consider upgrading to Starter ($7/month) for always-on service
- Starter tier has no sleep and faster response times
- Essential for live AMT HITs to prevent participant frustration

## Security Considerations

- MongoDB URI contains credentials - keep secure
- Session secrets should be random and unique
- AWS credentials (when added) should have minimal IAM permissions
- Consider IP restrictions for admin endpoints in production

## Monitoring

**Render Dashboard:**
- Monitor service health and uptime
- Check deployment logs for errors
- View resource usage and metrics

**Application Monitoring:**
- Use `/dashboard` endpoint to monitor experiment progress
- Check MongoDB Atlas for database metrics
- Monitor AMT costs if auto-HIT management is enabled

## Scaling Notes

- Free tier handles ~20 concurrent users comfortably
- Starter tier can handle 100+ concurrent users
- For large studies (500+ participants), consider Pro tier
- Database scaling handled by MongoDB Atlas automatically