<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Psychology Research Study - Complete</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Psychology Research Study</h1>
        </header>
        
        <main>
            <div class="completion-section">
                <h2>Study Complete</h2>
                
                <div class="completion-message">
                    <p>Thank you for participating in our research study! Your responses have been recorded successfully.</p>
                </div>
                
                <div style="background-color: #d4edda; border: 1px solid #c3e6cb; padding: 20px; border-radius: 5px; margin: 20px 0; text-align: center;">
                    <h3 style="color: #155724; margin-top: 0;">Your Completion Code:</h3>
                    <div style="font-size: 24px; font-weight: bold; color: #155724; background-color: white; padding: 10px; border: 2px solid #28a745; border-radius: 5px; margin: 10px 0;">
                        <span id="completion-code"><%= completionCode %></span>
                        <button type="button" class="copy-btn" onclick="copyToClipboard()" style="margin-left: 10px; padding: 5px 10px; background-color: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer;">ðŸ“‹ Copy</button>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <form id="amt-form" action="<%= turkSubmitTo || 'https://workersandbox.mturk.com' %>/mturk/externalSubmit" method="POST" target="_top">
                        <input type="hidden" name="assignmentId" value="<%= assignmentId %>">
                        <input type="hidden" name="completion_code" value="<%= completionCode %>">
                        <button type="submit" style="background-color: #28a745; color: white; border: none; padding: 15px 30px; font-size: 18px; border-radius: 5px; cursor: pointer;">
                            Submit to Amazon Mechanical Turk
                        </button>
                    </form>
                    <p style="margin-top: 10px; color: #666; font-size: 14px;">Click the button above to submit your work and receive payment.</p>
                    
                    <div id="submission-instructions" style="display: none; margin-top: 20px; padding: 15px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px;">
                        <p><strong>If the submission button doesn't work:</strong></p>
                        <ol style="text-align: left; margin: 10px 0;">
                            <li>Copy your completion code: <strong><%= completionCode %></strong></li>
                            <li>Close this tab/window</li>
                            <li>Return to the MTurk interface</li>
                            <li>Paste the completion code in the provided field</li>
                            <li>Submit your assignment</li>
                        </ol>
                    </div>
                </div>
                
                <script>
                document.addEventListener('DOMContentLoaded', function() {
                    const form = document.getElementById('amt-form');
                    
                    // Add form submission handler
                    form.addEventListener('submit', function(e) {
                        // Show manual instructions after a delay if submission seems stuck
                        setTimeout(() => {
                            document.getElementById('submission-instructions').style.display = 'block';
                        }, 3000);
                    });
                    
                    // Show manual instructions if in iframe (common issue)
                    if (window.parent !== window) {
                        setTimeout(() => {
                            document.getElementById('submission-instructions').style.display = 'block';
                        }, 3000);
                    }
                });
                </script>
                
                <div class="thank-you">
                    <h3>Thank You!</h3>
                    <p>Your participation contributes to important research in psychology and decision-making. If you have any questions about this study, please contact the research team.</p>
                </div>
            </div>
        </main>
        
        <footer>
            <p>All responses are confidential.</p>
        </footer>
    </div>
    
    <script>
        async function copyToClipboard() {
            const codeElement = document.getElementById('completion-code');
            const code = codeElement.textContent.trim();
            
            try {
                await navigator.clipboard.writeText(code);
                showCopySuccess();
            } catch (err) {
                console.error('Failed to copy text:', err);
                showCopyFailed();
            }
        }
        
        function showCopySuccess() {
            const button = document.querySelector('.copy-btn');
            const originalText = button.textContent;
            button.textContent = 'âœ“ Copied!';
            button.style.backgroundColor = '#28a745';
            button.style.color = 'white';
            
            setTimeout(() => {
                button.textContent = originalText;
                button.style.backgroundColor = '';
                button.style.color = '';
            }, 2000);
        }
        
        function showCopyFailed() {
            const button = document.querySelector('.copy-btn');
            const originalText = button.textContent;
            button.textContent = 'âš  Select text manually';
            button.style.backgroundColor = '#ffc107';
            button.style.color = 'black';
            
            // Select the code text for manual copying
            const codeElement = document.getElementById('completion-code');
            const range = document.createRange();
            range.selectNodeContents(codeElement);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            
            setTimeout(() => {
                button.textContent = originalText;
                button.style.backgroundColor = '';
                button.style.color = '';
            }, 3000);
        }
    </script>
</body>
</html>